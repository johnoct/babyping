# BabyPing V3 Design

## Overview

V3 adds three pillars: audio monitoring, event timeline dashboard, and Tailscale integration.

## Pillar 1: Audio Monitoring

### Backend (`audio.py`)
- New `AudioMonitor` class with its own thread
- Dependency: `sounddevice` (PortAudio wrapper)
- Captures audio in ~100ms chunks via `sounddevice.InputStream`
- Computes RMS amplitude per chunk for loudness measurement
- Shares state via `FrameBuffer` (new fields: `_audio_level`, `_last_sound_time`, `_audio_enabled`)
- Auto-calibrates threshold from first 3 seconds of ambient noise + margin

### CLI Flags
- `--no-audio` — disable audio monitoring
- `--audio-device N` — select input device (default: system default)
- `--audio-threshold N` — manual dB threshold (default: auto-calibrate)

### Web UI
- Real-time VU meter in status bar (horizontal bar, color-coded: gray → green → amber → red)
- Sound alert triggers same glow/chime system as motion alerts
- `GET /status` extended with: `audio_level`, `last_sound_time`, `audio_enabled`

## Pillar 2: Event Timeline Dashboard

### Backend (`events.py`)
- New `EventLog` class — stores events in `~/.babyping/events.jsonl`
- Event format: `{"type": "motion"|"sound", "timestamp": ..., "area": ..., "audio_level": ..., "snapshot": "..."}`
- Both motion and audio alert paths write to the event log
- Auto-prune: keep last 1000 events (`--max-events` flag)

### API
- `GET /events?limit=50&offset=0` — paginated event list
- `GET /timeline` — serves timeline HTML page

### Frontend
- Scrollable timeline page, newest first
- Event cards: icon (motion/sound), timestamp, details, snapshot thumbnail
- Filter buttons: All / Motion / Sound
- Auto-refresh every 5 seconds
- Same design language as main page

## Pillar 3: Tailscale Integration

### Auto-detection
- On startup, scan network interfaces for `100.x.x.x` (Tailscale CGNAT range)
- Print both LAN and Tailscale IPs in console
- Show "Secure" pill in web UI when accessed via Tailscale IP

### Documentation
- README section: install Tailscale, sign in, access via Tailscale IP

## Agent Team Execution

| Teammate | Owns | Primary Files |
|----------|------|---------------|
| audio-agent | Audio monitoring | `audio.py` (new), `babyping.py`, `web.py` (status bar) |
| timeline-agent | Event timeline | `events.py` (new), `web.py` (new page), `babyping.py` (event logging) |
| tailscale-agent | Tailscale integration | `babyping.py` (IP detection), `web.py` (secure pill), `README.md` |
